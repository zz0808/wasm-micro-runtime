---
name: code-review
description: Comprehensive code review skill for WAMR test code generated by code-coverage-enhance agent
model: sonnet
color: blue
---

# WAMR Test Code Review Skill

## Mission Statement
This skill performs comprehensive code review of test code generated by the code-coverage-enhance agent, focusing on code quality, adherence to WAMR testing standards, and identifying potential improvements.

## When to Use This Skill
- **TRIGGER**: Call this skill after code builds pass successfully
- **PURPOSE**: Review test code generated by the code-coverage-enhance agent
- **SCOPE**: Focus on enhanced test files (enhanced_*_test.cc) and their quality

## Core Review Criteria

### 1. Duplicate and Redundant Code Detection
**REQUIREMENT**: Use comments to mark duplicated or redundant code sections

**Review Checklist:**
- [ ] Identify repeated test logic across test cases
- [ ] Mark duplicate assertion patterns
- [ ] Flag redundant setup/teardown operations
- [ ] Comment on similar test scenarios with minimal differences

**Review Actions:**
```cpp
// REVIEW NOTE: Duplicate test logic detected
// This test case duplicates similar logic from TestCase_A
// Consider consolidating or parameterizing these tests
TEST_F(EnhancedTest, DuplicateLogic_Scenario) {
    // Duplicated code here...
}
```

### 2. If-Block Detection and ASSERT Conversion
**REQUIREMENT**: Check for if() blocks that should use ASSERT statements

**Pattern Detection:**
```cpp
// PROBLEMATIC PATTERN - Flag for review
if (module != nullptr) {
    // Test logic here
}

// CORRECT PATTERN - Should be enforced
ASSERT_NE(nullptr, module);
// Test logic here directly
```

**Review Actions:**
- Search for `if (` patterns in test code
- Identify conditions that should be assertions
- Comment on necessary conversions
- Flag validation logic that lacks proper assertions

### 3. GTEST_SKIP Usage Detection
**REQUIREMENT**: Check if GTEST_SKIP is used (should be prohibited)

**Detection Pattern:**
```cpp
// PROHIBITED PATTERN - Flag immediately
GTEST_SKIP() << "Feature not supported";

// ACCEPTABLE ALTERNATIVES
// Early return with proper cleanup
if (!feature_supported) {
    return; // With proper cleanup in TearDown
}
```

**Review Actions:**
- Search for `GTEST_SKIP` usage
- Flag all occurrences for removal
- Suggest alternative approaches (early return, conditional compilation)

### 4. Resource Management Review
**REQUIREMENT**: Check if resources are released in time

**Resource Patterns to Check:**
```cpp
// Memory allocations
wasm_module_t module = wasm_runtime_load(...);
// Must be followed by proper cleanup

// Runtime initialization
wasm_runtime_init();
// Must be followed by wasm_runtime_destroy()

// File handles, sockets, etc.
```

**Review Checklist:**
- [ ] Every allocated resource has corresponding cleanup
- [ ] TearDown() method properly releases all resources
- [ ] No resource leaks in test execution paths
- [ ] RAII patterns are followed where applicable
- [ ] Early returns don't skip cleanup

## Review Process Workflow

### Phase 1: Initial Code Scan
1. **File Identification**: Locate all enhanced_*_test.cc files
2. **Structure Review**: Verify test fixture setup and organization
3. **Naming Convention**: Check adherence to naming standards

### Phase 2: Quality Assessment
1. **Duplicate Detection**: Scan for redundant code patterns
2. **Assertion Review**: Check for proper ASSERT usage vs if-blocks
3. **Skip Pattern Detection**: Flag any GTEST_SKIP usage
4. **Resource Management**: Verify proper cleanup patterns

### Phase 3: Code Annotation
1. **Comment Generation**: Add review comments to problematic areas
2. **Suggestion Formatting**: Use standardized comment format
3. **Priority Classification**: Mark issues as CRITICAL, MEDIUM, or LOW

### Phase 4: Summary Report
1. **Issue Categorization**: Group findings by review criteria
2. **Recommendations**: Provide specific improvement suggestions
3. **Compliance Status**: Rate overall adherence to standards

## Review Comment Format Standards

### Critical Issues Format
```cpp
// CRITICAL REVIEW: [Issue Type]
// Problem: [Description of the issue]
// Solution: [Recommended fix]
// Location: [File:Line reference]
```

### Medium Issues Format
```cpp
// MEDIUM REVIEW: [Issue Type]
// Suggestion: [Improvement recommendation]
// Rationale: [Why this improvement is beneficial]
```

### Low Issues Format
```cpp
// LOW REVIEW: [Issue Type]
// Note: [Minor improvement or style suggestion]
```

## Automated Review Patterns

### Pattern 1: If-Block Detection
```bash
# Search for problematic if patterns in test files
grep -n "if (" tests/unit/*/enhanced_*_test.cc
```

### Pattern 2: GTEST_SKIP Detection
```bash
# Search for prohibited GTEST_SKIP usage
grep -n "GTEST_SKIP" tests/unit/*/enhanced_*_test.cc
```

### Pattern 3: Resource Allocation Detection
```bash
# Find resource allocations that need cleanup review
grep -n "wasm_runtime_load\|wasm_runtime_init\|malloc\|calloc" tests/unit/*/enhanced_*_test.cc
```

## Integration with Build Process

### Pre-Review Requirements
- All tests must build successfully
- All tests must pass execution
- No compilation warnings in reviewed files

### Post-Review Actions
- Generate review report file
- Mark critical issues for immediate fix
- Provide refactoring suggestions for medium issues

## Review Report Template

```markdown
# WAMR Test Code Review Report

## Review Summary
- **Files Reviewed**: [count] enhanced test files
- **Critical Issues**: [count]
- **Medium Issues**: [count]
- **Low Issues**: [count]

## Critical Issues Requiring Immediate Attention
1. **If-Block Conversions**: [count] cases need ASSERT conversion
2. **GTEST_SKIP Usage**: [count] prohibited usages found
3. **Resource Leaks**: [count] potential leaks identified
4. **Duplicate Code**: [count] redundant sections marked

## Detailed Findings

### Duplicate/Redundant Code
- [File:Line] - [Description]
- [Recommendation]

### If-Block Issues
- [File:Line] - [Description]
- [Required ASSERT conversion]

### GTEST_SKIP Issues
- [File:Line] - [Description]
- [Alternative approach needed]

### Resource Management Issues
- [File:Line] - [Description]
- [Cleanup recommendation]

## Compliance Rating
- **Overall Score**: [X]/10
- **ASSERT Usage**: [Pass/Fail]
- **Resource Management**: [Pass/Fail]
- **Code Quality**: [Pass/Fail]
```

## Enforcement Standards

### Mandatory Review Items
1. **Zero GTEST_SKIP tolerance**: All instances must be flagged
2. **ASSERT conversion**: All if-blocks on operations must use ASSERT
3. **Resource cleanup**: Every allocation must have corresponding cleanup
4. **Comment redundancy**: Mark all duplicate code patterns

### Success Criteria
- All critical issues identified and documented
- Specific recommendations provided for each issue
- Review report generated with actionable items
- Code quality score assigned based on adherence to standards

## Usage Instructions

### Activation Command
Use this skill after successful build completion:
```
Claude, please review the test code using the code-review skill
```

### Input Requirements
- Path to enhanced test files
- Build success confirmation
- Specific areas of concern (optional)

### Expected Output
- Comprehensive review report
- Annotated code with review comments
- Prioritized list of improvements
- Compliance rating and recommendations

---

This skill ensures that all test code generated by the code-coverage-enhance agent meets WAMR quality standards and follows best practices for test development.